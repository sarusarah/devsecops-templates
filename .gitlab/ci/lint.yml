---
# Linting and validation jobs for DevSecOps templates

# Validate all YAML template files
lint:yaml:
  stage: test
  image: python:3.12-slim
  before_script:
    - pip install -q yamllint pyyaml
  script:
    - echo "Validating YAML syntax for all template files..."
    - |
      # Find and validate all YAML files
      find templates/ examples/ -name "*.yml" -o -name "*.yaml" | while read file; do
        echo "Checking: $file"
        python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
        yamllint -d "{extends: default, rules: {line-length: {max: 200}, comments: disable}}" "$file" || exit 1
      done
    - echo "âœ… All YAML files are valid"
  rules:
    - when: always

# Validate template structure and required fields
lint:templates:
  stage: test
  image: python:3.12-slim
  script:
    - echo "Validating template structure..."
    - |
      # Check that all GitLab security templates have proper structure
      for template in templates/gitlab/security/*.yml; do
        echo "Checking structure: $template"

        # Check for OWASP SPVS comments
        if ! grep -q "OWASP SPVS" "$template"; then
          echo "Warning: $template missing OWASP SPVS documentation"
        fi

        # Check for stage definition
        if ! grep -q "stage:" "$template"; then
          echo "Error: $template missing stage definition"
          exit 1
        fi

        # Check for rules section
        if ! grep -q "rules:" "$template"; then
          echo "Warning: $template missing rules section"
        fi
      done
    - echo "All templates have valid structure"
  rules:
    - when: always

# Validate OWASP SPVS stage names are used correctly
lint:stages:
  stage: test
  image: alpine:3.20
  before_script:
    - apk add --no-cache grep
  script:
    - echo "Validating OWASP SPVS stage usage..."
    - |
      # Define valid OWASP SPVS stages
      VALID_STAGES="source build test package stage verify deploy operate report"

      # Check templates for valid stage names
      echo "Checking GitLab security templates..."
      for template in templates/gitlab/security/*.yml; do
        # Extract stage names from template
        stages=$(grep "^  stage:" "$template" | awk '{print $2}' || true)

        for stage in $stages; do
          echo "Checking stage '$stage' in $template"
          if ! echo "$VALID_STAGES" | grep -wq "$stage"; then
            echo "Invalid stage '$stage' found in $template"
            echo "Valid stages: $VALID_STAGES"
            exit 1
          fi
        done
      done

      # Check base.yml has all required stages
      echo "Checking base.yml for required stages..."
      for required_stage in $VALID_STAGES; do
        if ! grep -Fq -- "- $required_stage" templates/gitlab/base.yml; then
          echo "Required stage '$required_stage' missing in templates/gitlab/base.yml"
          exit 1
        fi
      done
    - echo "All stages follow OWASP SPVS naming convention"
  rules:
    - when: always

# Validate README and documentation
lint:documentation:
  stage: test
  image: node:20-alpine
  before_script:
    - npm install -g markdownlint-cli
  script:
    - echo "Linting Markdown documentation..."
    - |
      markdownlint \
        --config .markdownlint.json \
        README.md \
        docs/TESTING.md \
        docs/CHANGELOG.md \
        docs/CONTAINER_SCANNING.md \
        docs/CONTAINER_SCANNING_QUICKREF.md \
        docs/DEPENDENCY_TRACK.md \
        docs/README.md \
        dagger/README.md \
        || echo "Markdown linting warnings found (not blocking)"
    - echo "Documentation check complete"
  allow_failure: true
  rules:
    - when: always

