---
# GitLab CI/CD for DevSecOps Template Library
# Fast validation and security scanning pipeline

stages:
  - validate
  - test
  - release

# Include validation jobs
include:
  - local: /.gitlab/ci/lint.yml

# Default settings
default:
  interruptible: true

# Workflow rules
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'
    - when: never

# ============================================================================
# STAGE: validate - Quick validation checks
# ============================================================================

# Override lint jobs to run in validate stage
lint:yaml:
  stage: validate

lint:templates:
  stage: validate

lint:stages:
  stage: validate

lint:documentation:
  stage: validate

# Defense in depth: Two-tier security scanning strategy
#
# Tier 1 (Fast): Gitleaks specializes in secret detection, runs on all MRs/commits
#   - Catches hardcoded credentials, API keys, tokens before merge
#   - Fast execution (~10-30 seconds)
#   - Blocks pipeline if secrets found
#
# Tier 2 (Comprehensive): Trivy multi-scanner, runs only on default branch
#   - Scans for vulnerabilities, secrets, and misconfigurations
#   - Slower but more comprehensive (~1-2 minutes)
#   - Validates overall security posture after merge
#
# Why both? Gitleaks catches secrets early (better UX), Trivy provides defense in depth
# and catches things Gitleaks might miss, plus scans for other security issues.

security:secrets-gitleaks:
  stage: validate
  image: zricethezav/gitleaks:v8.21.2
  script:
    - gitleaks detect --redact --source . --no-git
  rules:
    - when: on_success

security:comprehensive-trivy:
  stage: validate
  image: aquasec/trivy:0.58.1
  script:
    - trivy fs --scanners vuln,secret,misconfig --severity HIGH,CRITICAL .
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never

# ============================================================================
# STAGE: test - Template validation
# ============================================================================

# Validate template composition - ensures no job name conflicts when templates are combined
#
# This test simulates how users compose multiple templates together in their .gitlab-ci.yml:
#   include:
#     - local: templates/gitlab/base.yml
#     - local: templates/gitlab/security/secrets.yml
#     - local: templates/gitlab/security/dependency.yml
#
# It verifies that:
#   1. All referenced templates can be loaded successfully
#   2. No two templates define jobs with the same name (which would cause conflicts)
#   3. The composition results in a valid CI/CD configuration
#
# This prevents breaking changes where a template accidentally reuses a job name
# from another template, causing user pipelines to fail.
test:composition:
  stage: test
  image: python:3.12-slim
  script:
    - pip install pyyaml
    - |
      python3 << 'EOF'
      import yaml, sys
      templates = ["templates/gitlab/base.yml", "templates/gitlab/security/secrets.yml",
                   "templates/gitlab/security/dependency.yml", "templates/gitlab/security/sast.yml"]
      jobs = {}
      for t in templates:
        content = yaml.safe_load(open(t))
        if content:
          for k, v in content.items():
            if isinstance(v, dict) and 'stage' in v:
              if k in jobs:
                print(f"Conflict: {k}"); sys.exit(1)
              jobs[k] = v
      print(f"Validated {len(templates)} templates, {len(jobs)} jobs")
      EOF

# ============================================================================
# STAGE: release - Create release artifacts
# ============================================================================

release:package:
  stage: release
  image: alpine:3.20
  before_script:
    - apk add --no-cache tar gzip
  script:
    - |
      mkdir -p release
      tar -czf release/devsecops-templates-${CI_COMMIT_TAG}.tar.gz \
        templates/ examples/ dagger/ *.md \
        --exclude='.git*' --exclude='*.pyc'
      cd release && sha256sum *.tar.gz > checksums.txt
  artifacts:
    paths:
      - release/
    expire_in: never
  rules:
    - if: '$CI_COMMIT_TAG'
