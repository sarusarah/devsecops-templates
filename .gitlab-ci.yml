---
# GitLab CI/CD for DevSecOps Template Library
# Fast validation and security scanning pipeline

stages:
  - validate
  - test
  - release

# Include validation jobs
include:
  - local: /.gitlab/ci/lint.yml

# Default settings
default:
  interruptible: true

# Workflow rules
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'
    - when: never

# ============================================================================
# STAGE: validate - Quick validation checks
# ============================================================================

# Override lint jobs to run in validate stage
lint:yaml:
  stage: validate

lint:gitlab-ci:
  stage: validate

lint:templates:
  stage: validate

lint:stages:
  stage: validate

lint:documentation:
  stage: validate

# Security: Scan for secrets
security:secrets:
  stage: validate
  image: zricethezav/gitleaks:v8.21.2
  script:
    - gitleaks detect --redact --source . --no-git
  rules:
    - when: on_success

# Security: Scan project with Trivy
security:trivy:
  stage: validate
  image: aquasec/trivy:0.58.1
  script:
    - trivy fs --scanners vuln,secret,misconfig --severity HIGH,CRITICAL .
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# ============================================================================
# STAGE: test - Template validation
# ============================================================================

# Validate template composition
test:composition:
  stage: test
  image: python:3.12-slim
  script:
    - pip install pyyaml
    - |
      python3 << 'EOF'
      import yaml, sys
      templates = ["templates/base.yml", "templates/security/secrets.yml",
                   "templates/security/dependency.yml", "templates/security/sast.yml"]
      jobs = {}
      for t in templates:
        content = yaml.safe_load(open(t))
        if content:
          for k, v in content.items():
            if isinstance(v, dict) and 'stage' in v:
              if k in jobs:
                print(f"Conflict: {k}"); sys.exit(1)
              jobs[k] = v
      print(f"Validated {len(templates)} templates, {len(jobs)} jobs")
      EOF

# ============================================================================
# STAGE: release - Create release artifacts
# ============================================================================

release:package:
  stage: release
  image: alpine:3.20
  before_script:
    - apk add --no-cache tar gzip
  script:
    - |
      mkdir -p release
      tar -czf release/devsecops-templates-${CI_COMMIT_TAG}.tar.gz \
        templates/ examples/ dagger/ *.md \
        --exclude='.git*' --exclude='*.pyc'
      cd release && sha256sum *.tar.gz > checksums.txt
  artifacts:
    paths:
      - release/
    expire_in: never
  rules:
    - if: '$CI_COMMIT_TAG'
