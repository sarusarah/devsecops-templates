---
# OWASP SPVS: Operate Phase - Security reporting and metrics
# Aggregate and report all security scan results

reporting:
  stage: report
  image: alpine:3.20
  script:
    - apk add --no-cache bash jq curl
    - |
      echo "# Pipeline Security Summary" > summary.md
      echo "" >> summary.md
      echo "- **Project**: ${CI_PROJECT_PATH}" >> summary.md
      echo "- **Commit**: ${CI_COMMIT_SHA}" >> summary.md
      echo "- **Branch**: ${CI_COMMIT_REF_NAME}" >> summary.md
      echo "- **Pipeline**: ${CI_PIPELINE_URL}" >> summary.md
      echo "- **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> summary.md
      echo "- **Security Scanner**: ${SECURITY_SCANNER}" >> summary.md
      echo "" >> summary.md

      # Track if any critical issues found
      CRITICAL_ISSUES=0

      # Aggregate known report files if present (both Trivy and specialized tool outputs)
      for f in secrets-report.json gitleaks-report.json dependency-scan.json sast-report.json semgrep.json iac-report.json polaris.json trivy.json zap/zap.json; do
        if [ -f "$f" ]; then
          echo "## Report: $f" >> summary.md

          # Count issues if JSON
          if command -v jq > /dev/null && [ "${f##*.}" = "json" ]; then
            ISSUE_COUNT=$(jq 'if type == "array" then length elif .results then (.results | length) else 0 end' "$f" 2>/dev/null || echo "0")
            echo "- **Issues found**: $ISSUE_COUNT" >> summary.md

            if [ "$ISSUE_COUNT" -gt 0 ]; then
              CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
            fi
          fi

          echo '```json' >> summary.md
          head -n 50 "$f" >> summary.md || true
          echo '```' >> summary.md
          echo "" >> summary.md
        fi
      done

      # Add summary
      echo "---" >> summary.md
      if [ $CRITICAL_ISSUES -gt 0 ]; then
        echo "⚠️  **Status**: $CRITICAL_ISSUES security scan(s) found issues" >> summary.md
      else
        echo "✅ **Status**: No critical security issues detected" >> summary.md
      fi

      # Optional Mattermost webhook
      if [ -n "${MATTERMOST_WEBHOOK_URL}" ]; then
        echo "Sending summary to Mattermost..."
        SUMMARY_TEXT=$(cat summary.md)
        payload=$(jq -n --arg text "$SUMMARY_TEXT" '{text: $text}')
        curl -X POST -H "Content-Type: application/json" -d "$payload" "${MATTERMOST_WEBHOOK_URL}" || true
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - summary.md
    reports:
      dotenv: summary.md
