# OWASP SPVS: Develop Phase - Secure coding and continuous reviews
# Static Application Security Testing (SAST) - Analyze source code for security vulnerabilities

# Trivy-based SAST (basic misconfiguration and security checks)
sast:
  stage: source
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      trivy fs \
        --scanners misconfig \
        --severity HIGH,CRITICAL \
        --format json \
        --output sast-report.json \
        .
  rules:
    - if: '$ENABLE_SAST == "true" && ($SECURITY_SCANNER == "trivy" || $SAST_TOOL == "trivy")'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - sast-report.json
    reports:
      sast: sast-report.json

# Semgrep-based SAST (comprehensive security analysis)
sast-semgrep:
  stage: source
  image: returntocorp/semgrep:1.97.0
  script:
    - semgrep --version
    # Using p/security-audit config (doesn't require metrics)
    # Alternative: use 'auto' but remove --metrics off
    - semgrep scan --config p/security-audit --json -o semgrep.json .
  rules:
    - if: '$ENABLE_SAST == "true" && ($SECURITY_SCANNER == "specialized" || $SAST_TOOL == "semgrep")'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - semgrep.json
    reports:
      sast: semgrep.json
