dast-zap:
  stage: validate
  image: ghcr.io/zaproxy/zaproxy:2.15.0
  script:
    - |
      if [ -z "${STAGING_URL}" ]; then
        echo "STAGING_URL is required for DAST."
        exit 2
      fi
      mkdir -p zap
      # Run ZAP baseline scan - exit code 2 means warnings, 1 means alerts found
      set +e
      zap-baseline.py -t "${STAGING_URL}" -J zap/zap.json -r zap/zap.html
      ZAP_EXIT_CODE=$?
      set -e

      # Allow warnings (exit 2) but fail on alerts (exit 1) if SECURITY_POLICY is strict
      if [ "$SECURITY_POLICY" = "strict" ] && [ $ZAP_EXIT_CODE -eq 1 ]; then
        echo "DAST found security alerts in strict mode"
        exit 1
      fi
      exit 0
  rules:
    - if: '$ENABLE_DAST == "true"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - zap/zap.json
      - zap/zap.html
    reports:
      dast: zap/zap.json
