# OWASP SPVS: Integrate Phase - Artifact integrity and security validation
# Scan container images for vulnerabilities, misconfigurations, and security issues

container-security-scan:
  stage: package
  image: aquasec/trivy:0.58.1
  before_script:
    - |
      # Authenticate with container registry if credentials are provided (if image needs to be pulled from private registry)
      if [ -n "${CI_REGISTRY}" ] && [ -n "${CI_REGISTRY_USER}" ] && [ -n "${CI_REGISTRY_PASSWORD}" ]; then
        export TRIVY_USERNAME="${CI_REGISTRY_USER}"
        export TRIVY_PASSWORD="${CI_REGISTRY_PASSWORD}"
      fi
  script:
    - trivy --version
    - |
      if [ -z "${IMAGE_NAME}" ]; then
        echo "IMAGE_NAME is required (e.g. CI_REGISTRY_IMAGE)."
        exit 2
      fi
      IMAGE_REF="${IMAGE_NAME}:${IMAGE_TAG:-$CI_COMMIT_SHA}"
      echo "Scanning image: ${IMAGE_REF}"
      trivy image \
        --severity "${TRIVY_SEVERITY}" \
        --exit-code "${TRIVY_EXIT_CODE}" \
        --format json \
        --output trivy.json \
        "${IMAGE_REF}"
  rules:
    - if: '$ENABLE_CONTAINER_SCAN == "true"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - trivy.json
    reports:
      container_scanning: trivy.json
