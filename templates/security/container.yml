# OWASP SPVS: Integrate Phase - Artifact integrity and security validation
# Scan container images for vulnerabilities, misconfigurations, and security issues

container-security-scan:
  stage: package
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      IMAGE_REPO="${IMAGE_NAME:-$CI_REGISTRY_IMAGE}"
      IMAGE_TAG="${IMAGE_TAG:-latest}"
      IMAGE_REF="${IMAGE_REPO}:${IMAGE_TAG}"

      echo "Scanning image: ${IMAGE_REF}"
      trivy image \
        --severity "${TRIVY_SEVERITY}" \
        --exit-code "${TRIVY_EXIT_CODE}" \
        --format json \
        --output trivy.json \
        "${IMAGE_REF}"
  rules:
    - if: '$ENABLE_CONTAINER_SCAN == "true"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - trivy.json
    reports:
      container_scanning: trivy.json
