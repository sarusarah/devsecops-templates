# OWASP SPVS: Develop Phase - Source code security
# Scan for hardcoded secrets, API keys, passwords, and sensitive data

# Trivy-based secret scanning (recommended for unified tooling)
secrets-detection:
  stage: source
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      trivy fs \
        --scanners secret \
        --severity HIGH,CRITICAL \
        --format json \
        --output secrets-report.json \
        .
  rules:
    - if: '$ENABLE_SECRETS == "true" && $SECURITY_SCANNER == "trivy"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - secrets-report.json

# Gitleaks-based secret scanning (specialized tool)
secrets-detection-gitleaks:
  stage: source
  image: zricethezav/gitleaks:v8.21.2
  script:
    - gitleaks detect --redact --source . --report-path gitleaks-report.json --report-format json --no-git
  rules:
    - if: '$ENABLE_SECRETS == "true" && $SECURITY_SCANNER == "specialized"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - gitleaks-report.json
