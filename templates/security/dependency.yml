# OWASP SPVS: Develop Phase - Source code security
# Software Composition Analysis (SCA) - Scan dependencies for known vulnerabilities

# Trivy-based dependency scanning (recommended for unified tooling)
dependency-scanning:
  stage: source
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      trivy fs \
        --scanners vuln \
        --severity HIGH,CRITICAL \
        --format json \
        --output dependency-scan.json \
        .
  rules:
    - if: '$ENABLE_DEPENDENCY_SCAN == "true" && $SECURITY_SCANNER == "trivy"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - dependency-scan.json
    reports:
      dependency_scanning: dependency-scan.json

# Language-specific dependency scanning (specialized tools)
dependency-scanning-specialized:
  stage: source
  image: alpine:3.20
  script:
    - apk add --no-cache bash curl jq python3 py3-pip nodejs npm php-cli php-phar php-openssl
    - |
      set -e
      case "${LANGUAGE}" in
        php)
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          composer audit --format=json > dependency-scan.json || true
          ;;
        python)
          pip install -U pip pip-audit
          if [ -f "requirements.txt" ]; then pip-audit -r requirements.txt -f json > dependency-scan.json || true; else echo "[]" > dependency-scan.json; fi
          ;;
        node)
          if [ -f "package-lock.json" ] || [ -f "package.json" ]; then npm audit --json > dependency-scan.json || true; else echo "{}" > dependency-scan.json; fi
          ;;
        *)
          echo "{}" > dependency-scan.json
          ;;
      esac
  rules:
    - if: '$ENABLE_DEPENDENCY_SCAN == "true" && $SECURITY_SCANNER == "specialized"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - dependency-scan.json
    reports:
      dependency_scanning: dependency-scan.json
