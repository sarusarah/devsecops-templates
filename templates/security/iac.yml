---
# OWASP SPVS: Integrate Phase - Infrastructure as Code security
# Scan Kubernetes manifests, Terraform, Dockerfiles, and other IaC for misconfigurations

# Trivy-based IaC scanning (recommended for unified tooling)
iac-security:
  stage: package
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      TARGET_DIR="${PROJECT_PATH:-.}/${IAC_TARGET_DIR:-k8s}"
      if [ ! -d "${TARGET_DIR}" ]; then
        echo "No IaC target dir '${TARGET_DIR}' found. Set IAC_TARGET_DIR or disable ENABLE_IAC_SCAN."
        exit 0
      fi
      trivy config \
        --severity HIGH,CRITICAL \
        --format json \
        --output iac-report.json \
        "${TARGET_DIR}"
  rules:
    - if: '$ENABLE_IAC_SCAN == "true" && $SECURITY_SCANNER == "trivy"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - iac-report.json

# Specialized IaC scanning (Kubeconform, Kube-Score, Polaris)
iac-security-specialized:
  stage: package
  image: alpine:3.20
  script:
    - apk add --no-cache bash curl
    # kubeconform
    - curl -sSL -o /usr/local/bin/kubeconform https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64
    - chmod +x /usr/local/bin/kubeconform
    # kubescore
    - curl -sSL -o /usr/local/bin/kubescore https://github.com/zegl/kube-score/releases/latest/download/kube-score_linux_amd64
    - chmod +x /usr/local/bin/kubescore
    # polaris (binary)
    - curl -sSL -o /usr/local/bin/polaris https://github.com/FairwindsOps/polaris/releases/latest/download/polaris_linux_amd64
    - chmod +x /usr/local/bin/polaris
    - |
      set -e
      TARGET_DIR="${PROJECT_PATH:-.}/${IAC_TARGET_DIR:-k8s}"
      if [ ! -d "${TARGET_DIR}" ]; then
        echo "No IaC target dir '${TARGET_DIR}' found. Set IAC_TARGET_DIR or disable ENABLE_IAC_SCAN."
        exit 0
      fi
      kubeconform -summary -strict "${TARGET_DIR}" || true
      # kubescore expects rendered manifests; teams can override with their render step
      find "${TARGET_DIR}" -name '*.yaml' -o -name '*.yml' | head -n 50 | xargs -I{} sh -c 'kubescore score "{}" || true'
      polaris audit --audit-path "${TARGET_DIR}" --format json > polaris.json || true
  rules:
    - if: '$ENABLE_IAC_SCAN == "true" && $SECURITY_SCANNER == "specialized"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - polaris.json
