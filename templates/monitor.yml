post-deployment-monitoring:
  stage: monitor
  image: alpine:3.20
  script:
    - apk add --no-cache curl bash
    - |
      if [ -z "${HEALTHCHECK_URL}" ]; then
        echo "HEALTHCHECK_URL not set. Skipping monitoring."
        exit 0
      fi
      echo "Waiting for deployment to stabilize..."
      sleep "${MONITOR_WAIT_SECONDS:-20}"
      echo "Checking health at ${HEALTHCHECK_URL}..."
      curl -fsS "${HEALTHCHECK_URL}"
      echo "Health check OK."
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
