---
# OWASP SPVS: Release Phase - Staging deployment
# Staging Deployment - GitOps-based deployment to staging environment
#
# Deploys applications to staging environment using GitOps methodology. Updates the
# GitOps repository with new image tags, triggering automated deployment via ArgoCD,
# Flux, or similar GitOps operators.
#
# Quick Start:
#   variables:
#     GITOPS_REPO: "git@gitlab.example.com:gitops/myapp.git"
#     GITOPS_SSH_KEY: "${GITOPS_SSH_KEY}"  # Set as CI/CD secret
#     STAGING_URL: "https://staging.example.com"
#
# How It Works:
#   1. Clone GitOps repository
#   2. Update image tag in values file (using yq)
#   3. Commit and push changes
#   4. GitOps operator detects change
#   5. Operator deploys to Kubernetes/target platform
#
# Variables:
#   GITOPS_REPO: ""                     # Required: GitOps repository URL
#   GITOPS_SSH_KEY: ""                  # Required: SSH private key for GitOps repo
#   GITOPS_PATH: "values.yaml"          # Path to values file (default: "values.yaml")
#   GITOPS_IMAGE_TAG_YQ_PATH: ".image.tag"  # YQ path to image tag field
#   GITOPS_COMMIT_MESSAGE: ""           # Commit message template
#   IMAGE_TAG: ""                       # Image tag to deploy (default: CI_COMMIT_SHA)
#   STAGING_URL: ""                     # Staging environment URL
#
# GitOps Repository Structure:
#   Typical structure:
#     values.yaml          # Helm values or config
#     staging/
#       values.yaml        # Staging-specific values
#     production/
#       values.yaml        # Production-specific values
#
# SSH Key Setup:
#   1. Generate SSH key: ssh-keygen -t ed25519 -C "gitlab-ci"
#   2. Add public key to GitOps repository (deploy keys)
#   3. Add private key as CI/CD variable: GITOPS_SSH_KEY
#   4. Set variable as "Masked" in GitLab CI/CD settings
#
# YQ Path Examples:
#   Simple: .image.tag
#   Nested: .services.frontend.image.tag
#   Array: .deployments[0].image.tag
#
# Pipeline Behavior:
#   Default branch: Automatic deployment
#   Merge requests: Manual deployment (when: manual)
#   Other branches: No deployment
#
# Environment Integration:
#   Creates GitLab environment:
#     - Name: staging
#     - URL: STAGING_URL
#     - Deployment tier: staging
#   Visible in GitLab Environments page
#
# Customization:
#   Override for custom deployment logic:
#   deploy-staging:
#     extends: .deploy:staging:base
#     variables:
#       GITOPS_PATH: "staging/values.yaml"
#       IMAGE_TAG: "${CI_COMMIT_TAG}"
#
# Troubleshooting:
#   "GITOPS_REPO is required":
#     - Set GITOPS_REPO variable in .gitlab-ci.yml
#
#   SSH authentication failed:
#     - Verify GITOPS_SSH_KEY is correctly set
#     - Ensure public key is added to GitOps repo
#
#   "No changes to commit":
#     - Image tag already deployed (not an error)
#
# See Also:
#   - https://argoproj.github.io/cd/
#   - https://fluxcd.io/

.deploy:staging:base:
  stage: stage
  image: alpine/git:latest
  before_script:
    - apk add --no-cache yq bash curl
    - |
      # Verify required variables
      if [ -z "${GITOPS_REPO}" ]; then
        echo "GITOPS_REPO is required (e.g., git@gitlab.example.com:gitops/app.git)"
        exit 1
      fi
      # Setup SSH key for GitOps repo
      if [ -n "${GITOPS_SSH_KEY}" ]; then
        mkdir -p ~/.ssh
        echo "${GITOPS_SSH_KEY}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts 2>/dev/null || true
      fi
  script:
    - |
      echo "Deploying to staging via GitOps..."

      # Clone GitOps repository
      git clone "${GITOPS_REPO}" gitops-repo
      cd gitops-repo

      # Configure git
      git config user.email "ci@${CI_PROJECT_PATH_SLUG}.gitlab.com"
      git config user.name "GitLab CI"

      # Update image tag in values file
      IMAGE_TAG_VALUE="${IMAGE_TAG:-$CI_COMMIT_SHA}"
      GITOPS_FILE="${GITOPS_PATH:-values.yaml}"
      YQ_PATH="${GITOPS_IMAGE_TAG_YQ_PATH:-.image.tag}"

      echo "Updating ${GITOPS_FILE} at path ${YQ_PATH} to ${IMAGE_TAG_VALUE}"

      # Update the file using yq
      yq eval "${YQ_PATH} = \"${IMAGE_TAG_VALUE}\"" -i "${GITOPS_FILE}"

      # Commit and push changes
      git add "${GITOPS_FILE}"
      git diff --cached --quiet && echo "No changes to commit" && exit 0

      COMMIT_MSG="${GITOPS_COMMIT_MESSAGE:-Deploy ${CI_COMMIT_SHORT_SHA} to staging}"
      git commit -m "${COMMIT_MSG}"
      git push origin HEAD

      echo "Successfully deployed ${IMAGE_TAG_VALUE} to staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
    - when: never
  environment:
    name: staging
    url: ${STAGING_URL}
    deployment_tier: staging

deploy-staging:
  extends: .deploy:staging:base
  variables:
    IMAGE_TAG: ${CI_COMMIT_SHA}
