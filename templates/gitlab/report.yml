---
# OWASP SPVS: Operate Phase - Security reporting and metrics
# Security Reporting - Aggregate and summarize scan results
#
# Collects and aggregates all security scan results from the pipeline, generates a
# comprehensive security summary, and optionally sends notifications to Mattermost
# or other communication platforms.
#
# Quick Start:
#   Automatically runs after pipeline completes
#   Optional: Set MATTERMOST_WEBHOOK_URL for notifications
#
# Variables:
#   MATTERMOST_WEBHOOK_URL: ""          # Optional: Mattermost webhook for notifications
#   SECURITY_SCANNER: "trivy"           # Scanner type (automatically set by base.yml)
#
# Generated Reports:
#   Creates summary.md with:
#     - Pipeline metadata (project, commit, branch)
#     - Security scanner information
#     - Aggregated scan results
#     - Issue counts per scan type
#     - Overall security status
#
# Scanned Report Files:
#   Secrets:
#     - secrets-report.json (Trivy)
#     - gitleaks-report.json (Gitleaks)
#
#   Dependencies:
#     - dependency-scan.json (Trivy or language-specific)
#
#   SAST:
#     - sast-report.json (Trivy)
#     - semgrep.json (Semgrep)
#
#   IaC:
#     - iac-report.json (Trivy)
#     - polaris.json (Polaris)
#
#   Container:
#     - trivy.json (Trivy)
#
#   DAST:
#     - zap/zap.json (OWASP ZAP)
#
# Pipeline Integration:
#   Runs in report stage (final stage)
#   Only on default branch and merge requests
#   Runs even if previous stages have warnings
#
# Notification Integration:
#   Mattermost:
#     1. Create incoming webhook in Mattermost
#     2. Set MATTERMOST_WEBHOOK_URL as CI/CD variable
#     3. Report automatically sent on pipeline completion
#
#   Example webhook URL:
#     https://mattermost.example.com/hooks/xxx-xxx-xxx
#
# Artifacts:
#   summary.md:
#     - Markdown formatted report
#     - Expires after 30 days
#     - Downloadable from pipeline artifacts
#     - Viewable in GitLab UI
#
# Custom Reporting:
#   Extend for additional platforms:
#   reporting:
#     script:
#       - ./generate-report.sh
#       - ./send-to-slack.sh
#       - ./send-to-email.sh
#
# See Also:
#   - https://docs.mattermost.com/developer/webhooks-incoming.html
#   - https://docs.gitlab.com/ee/ci/yaml/artifacts_reports.html

reporting:
  stage: report
  image: alpine:3.20
  script:
    - apk add --no-cache bash jq curl
    - |
      echo "# Pipeline Security Summary" > summary.md
      echo "" >> summary.md
      echo "- **Project**: ${CI_PROJECT_PATH}" >> summary.md
      echo "- **Commit**: ${CI_COMMIT_SHA}" >> summary.md
      echo "- **Branch**: ${CI_COMMIT_REF_NAME}" >> summary.md
      echo "- **Pipeline**: ${CI_PIPELINE_URL}" >> summary.md
      echo "- **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> summary.md
      echo "- **Security Scanner**: ${SECURITY_SCANNER}" >> summary.md
      echo "" >> summary.md

      # Track if any critical issues found
      CRITICAL_ISSUES=0

      # Aggregate known report files if present (both Trivy and specialized tool outputs)
      for f in secrets-report.json gitleaks-report.json dependency-scan.json sast-report.json semgrep.json iac-report.json polaris.json trivy.json zap/zap.json; do
        if [ -f "$f" ]; then
          echo "## Report: $f" >> summary.md

          # Count issues if JSON
          if command -v jq > /dev/null && [ "${f##*.}" = "json" ]; then
            ISSUE_COUNT=$(jq 'if type == "array" then length elif .results then (.results | length) else 0 end' "$f" 2>/dev/null || echo "0")
            echo "- **Issues found**: $ISSUE_COUNT" >> summary.md

            if [ "$ISSUE_COUNT" -gt 0 ]; then
              CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
            fi
          fi

          echo '```json' >> summary.md
          head -n 50 "$f" >> summary.md || true
          echo '```' >> summary.md
          echo "" >> summary.md
        fi
      done

      # Add summary
      echo "---" >> summary.md
      if [ $CRITICAL_ISSUES -gt 0 ]; then
        echo "Status: $CRITICAL_ISSUES security scan(s) found issues" >> summary.md
      else
        echo "Status: No critical security issues detected" >> summary.md
      fi

      # Optional Mattermost webhook
      if [ -n "${MATTERMOST_WEBHOOK_URL}" ]; then
        echo "Sending summary to Mattermost..."
        SUMMARY_TEXT=$(cat summary.md)
        payload=$(jq -n --arg text "$SUMMARY_TEXT" '{text: $text}')
        curl -X POST -H "Content-Type: application/json" -d "$payload" "${MATTERMOST_WEBHOOK_URL}" || true
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - summary.md
    reports:
      dotenv: summary.md
