---
# OWASP SPVS: Integrate Phase - Artifact integrity and security validation
# Container Security Scanning - Vulnerability detection in Docker/OCI images
#
# Scans Docker and OCI container images for vulnerabilities in OS packages, application
# dependencies, and misconfigurations. Uses remote scanning to work without Docker daemon,
# ideal for GitLab CI environments.
#
# Quick Start:
#   variables:
#     ENABLE_CONTAINER_SCAN: "true"
#     IMAGE_TAG: "latest"  # Must match your build tag
#
# Multi-Environment Images:
#   For projects with staging/prod images (e.g., myapp/staging:latest, myapp/prod:latest):
#   variables:
#     CONTAINER_IMAGE_SUFFIX: "staging"  # Scans IMAGE_NAME/staging:TAG
#
# Variables:
#   ENABLE_CONTAINER_SCAN: "true"       # Enable container scanning (default: "false")
#   IMAGE_NAME: ""                      # Image repository (default: CI_REGISTRY_IMAGE)
#   IMAGE_TAG: ""                       # Image tag to scan (default: CI_COMMIT_SHORT_SHA)
#   CONTAINER_IMAGE_SUFFIX: ""          # Optional: Sub-image path (e.g., "staging")
#   TRIVY_SEVERITY: ""                  # Severities to report (default: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL")
#   TRIVY_EXIT_CODE: "0"                # Exit code on vulnerabilities: "0" (warn) or "1" (fail)
#   TRIVY_NON_SSL: "false"              # Allow insecure registries (default: "false")
#
# Image Reference Construction:
#   Final image: ${IMAGE_NAME}/${CONTAINER_IMAGE_SUFFIX}:${IMAGE_TAG}
#   Examples:
#     - registry/project:abc123 (default)
#     - registry/project/staging:latest (with CONTAINER_IMAGE_SUFFIX="staging")
#     - docker.io/org/app:v1.0.0 (external registry)
#
# Registry Authentication:
#   GitLab CI: Automatic via CI_REGISTRY_USER and CI_JOB_TOKEN
#   External: Set CI_REGISTRY_USER and CI_REGISTRY_PASSWORD variables
#
# Monorepo Support:
#   Each component can have its own container scan job:
#   container-security-scan:frontend:
#     extends: container-security-scan
#     variables:
#       CONTAINER_IMAGE_SUFFIX: "frontend"
#
# See Also:
#   - Complete guide: docs/CONTAINER_SCANNING.md
#   - https://aquasecurity.github.io/trivy/

container-security-scan:
  stage: package
  image: aquasec/trivy:0.58.1
  before_script:
    - |
      # Authenticate with container registry for remote scanning
      export TRIVY_USERNAME="${CI_REGISTRY_USER:-gitlab-ci-token}"
      export TRIVY_PASSWORD="${CI_REGISTRY_PASSWORD:-$CI_JOB_TOKEN}"
      export TRIVY_NON_SSL="false"
  script:
    - trivy --version
    - |
      IMAGE_REPO="${IMAGE_NAME:-$CI_REGISTRY_IMAGE}"
      IMAGE_TAG="${IMAGE_TAG:-$CI_COMMIT_SHORT_SHA}"

      # Support scanning sub-images (e.g., CI_REGISTRY_IMAGE/staging or CI_REGISTRY_IMAGE/prod)
      if [ -n "$CONTAINER_IMAGE_SUFFIX" ]; then
        IMAGE_REPO="${IMAGE_REPO}/${CONTAINER_IMAGE_SUFFIX}"
      fi

      IMAGE_REF="${IMAGE_REPO}:${IMAGE_TAG}"

      echo "================================================"
      echo "Scanning container image for vulnerabilities"
      echo "Registry: ${IMAGE_REPO}"
      echo "Tag: ${IMAGE_TAG}"
      echo "Full reference: ${IMAGE_REF}"
      echo "================================================"

      # Use remote scanning since docker daemon is not available in GitLab CI
      trivy image \
        --severity "${TRIVY_SEVERITY:-UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL}" \
        --exit-code "${TRIVY_EXIT_CODE:-0}" \
        --format json \
        --output trivy.json \
        --image-src remote \
        --insecure="${TRIVY_NON_SSL}" \
        "${IMAGE_REF}"

      # Also generate a table format for easier reading in job logs
      echo ""
      echo "Vulnerability Summary:"
      echo "================================================"
      trivy image \
        --severity "${TRIVY_SEVERITY:-UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL}" \
        --format table \
        --image-src remote \
        --insecure="${TRIVY_NON_SSL}" \
        "${IMAGE_REF}"
  rules:
    - if: '$ENABLE_CONTAINER_SCAN == "true"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - trivy.json
    reports:
      container_scanning: trivy.json
