---
# OWASP SPVS: Integrate Phase - Infrastructure as Code security
# IaC Security Scanning - Detect misconfigurations and security issues
#
# Scans Infrastructure as Code files (Kubernetes manifests, Terraform, Dockerfiles,
# Helm charts, etc.) for security misconfigurations, policy violations, and best
# practice deviations before deployment.
#
# Quick Start:
#   variables:
#     ENABLE_IAC_SCAN: "true"
#     IAC_TARGET_DIR: "k8s"  # Directory containing IaC files
#     SECURITY_SCANNER: "trivy"  # or "specialized"
#
# Scanner Options:
#   Trivy (Default):
#     - Unified IaC scanner
#     - Supports multiple formats
#     - Fast and comprehensive
#     - Best for most projects
#
#   Specialized Tools:
#     - Kubeconform: Kubernetes manifest validation
#     - Kube-Score: Kubernetes best practices
#     - Polaris: Kubernetes security audit
#     - Best for Kubernetes-specific validation
#
# Variables:
#   ENABLE_IAC_SCAN: "true"             # Enable IaC scanning (default: "false")
#   SECURITY_SCANNER: "trivy"           # Scanner: "trivy" or "specialized" (default: "trivy")
#   IAC_TARGET_DIR: "k8s"               # Directory with IaC files (default: "k8s")
#   PROJECT_PATH: ""                    # Monorepo: subproject path (e.g., "infra")
#   SECURITY_POLICY: "strict"           # Policy: "strict" or "permissive" (default: "strict")
#
# Supported IaC Formats:
#   Trivy: Kubernetes, Terraform, CloudFormation, Dockerfile, Helm, Kustomize
#   Specialized: Kubernetes manifests (YAML)
#
# Directory Structure:
#   Common patterns:
#     - k8s/ (Kubernetes manifests)
#     - terraform/ (Terraform files)
#     - helm/ (Helm charts)
#     - infra/ (Mixed infrastructure code)
#
# Monorepo Support:
#   Scan specific infrastructure directory:
#   variables:
#     PROJECT_PATH: "services/api"
#     IAC_TARGET_DIR: "k8s"
#     ENABLE_IAC_SCAN: "true"
#   # Scans: services/api/k8s/
#
# See Also:
#   - https://aquasecurity.github.io/trivy/
#   - https://github.com/yannh/kubeconform
#   - https://github.com/zegl/kube-score
#   - https://www.fairwinds.com/polaris

# Trivy-based IaC scanning (recommended for unified tooling)
iac-security:
  stage: package
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      TARGET_DIR="${PROJECT_PATH:-.}/${IAC_TARGET_DIR:-k8s}"
      if [ ! -d "${TARGET_DIR}" ]; then
        echo "No IaC target dir '${TARGET_DIR}' found. Set IAC_TARGET_DIR or disable ENABLE_IAC_SCAN."
        exit 0
      fi
      trivy config \
        --severity HIGH,CRITICAL \
        --format json \
        --output iac-report.json \
        "${TARGET_DIR}"
  rules:
    - if: '$ENABLE_IAC_SCAN == "true" && $SECURITY_SCANNER == "trivy"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - iac-report.json

# Specialized IaC scanning (Kubeconform, Kube-Score, Polaris)
iac-security-specialized:
  stage: package
  image: alpine:3.20
  script:
    - apk add --no-cache bash curl
    - curl -sSL -o /usr/local/bin/kubeconform https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64
    - chmod +x /usr/local/bin/kubeconform
    - curl -sSL -o /usr/local/bin/kubescore https://github.com/zegl/kube-score/releases/latest/download/kube-score_linux_amd64
    - chmod +x /usr/local/bin/kubescore
    - curl -sSL -o /usr/local/bin/polaris https://github.com/FairwindsOps/polaris/releases/latest/download/polaris_linux_amd64
    - chmod +x /usr/local/bin/polaris
    - |
      set -e
      TARGET_DIR="${PROJECT_PATH:-.}/${IAC_TARGET_DIR:-k8s}"
      if [ ! -d "${TARGET_DIR}" ]; then
        echo "No IaC target dir '${TARGET_DIR}' found. Set IAC_TARGET_DIR or disable ENABLE_IAC_SCAN."
        exit 0
      fi
      kubeconform -summary -strict "${TARGET_DIR}" || true
      find "${TARGET_DIR}" -name '*.yaml' -o -name '*.yml' | head -n 50 | xargs -I{} sh -c 'kubescore score "{}" || true'
      polaris audit --audit-path "${TARGET_DIR}" --format json > polaris.json || true
  rules:
    - if: '$ENABLE_IAC_SCAN == "true" && $SECURITY_SCANNER == "specialized"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - polaris.json
