---
# OWASP SPVS: Develop Phase - Source code security
# Secrets Detection - Scan for hardcoded credentials and sensitive data
#
# Scans source code for hardcoded secrets, API keys, passwords, tokens, and other
# sensitive data that should not be committed to version control. Runs in the preflight
# stage to catch issues before building or deploying.
#
# Quick Start:
#   variables:
#     ENABLE_SECRETS: "true"
#     SECURITY_SCANNER: "trivy"  # or "specialized" for Gitleaks
#
# Scanner Options:
#   Trivy (Default):
#     - Unified scanning tool
#     - Fast and lightweight
#     - Good for CI/CD pipelines
#
#   Gitleaks (Specialized):
#     - Purpose-built for secret detection
#     - More comprehensive pattern matching
#     - Slower but more accurate
#
# Variables:
#   ENABLE_SECRETS: "true"              # Enable secrets scanning (default: "true")
#   SECURITY_SCANNER: "trivy"           # Scanner to use: "trivy" or "specialized" (default: "trivy")
#   PROJECT_PATH: ""                    # Monorepo: subproject path to scan (e.g., "frontend")
#   SECURITY_POLICY: "strict"           # Policy mode: "strict" (fail on findings) or "permissive" (default: "strict")
#
# Monorepo Support:
#   Set PROJECT_PATH to scan a specific subdirectory:
#   variables:
#     PROJECT_PATH: "frontend"
#     ENABLE_SECRETS: "true"
#
# See Also:
#   - https://aquasecurity.github.io/trivy/
#   - https://github.com/gitleaks/gitleaks

# Trivy-based secret scanning (recommended for unified tooling)
secrets-detection:
  stage: source
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      trivy fs \
        --scanners secret \
        --severity HIGH,CRITICAL \
        --format json \
        --output secrets-report.json \
        "${PROJECT_PATH:-.}"
  rules:
    - if: '$ENABLE_SECRETS == "true" && $SECURITY_SCANNER == "trivy"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - secrets-report.json

# Gitleaks-based secret scanning (specialized tool)
secrets-detection-gitleaks:
  stage: source
  image: zricethezav/gitleaks:v8.21.2
  script:
    - gitleaks detect --redact --source "${PROJECT_PATH:-.}" --report-path gitleaks-report.json --report-format json --no-git
  rules:
    - if: '$ENABLE_SECRETS == "true" && $SECURITY_SCANNER == "specialized"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - gitleaks-report.json
