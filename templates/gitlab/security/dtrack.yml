---
# OWASP SPVS: Develop Phase - Source code security
# Software Bill of Materials (SBOM) - Upload dependency inventory to Dependency-Track
#
# Generates CycloneDX SBOM using Trivy and uploads to Dependency-Track for centralized
# dependency and vulnerability tracking across all projects.
#
# Quick Start:
#   variables:
#     ENABLE_DTRACK: "true"
#     # DTRACK_URL defaults to https://api.dtrack.cnc-demo.liip.cloud
#     # DTRACK_API_KEY: Set as CI/CD secret (do not define in variables)
#
# Project Identification:
#   Option 1 - Use existing project UUID:
#     DTRACK_PROJECT_UUID: "abc-123-def-456"
#
#   Option 2 - Auto-create project with name+version:
#     # Leave DTRACK_PROJECT_UUID unset
#     # Project name auto-generated from CI_PROJECT_PATH
#     # For monorepo: Set PROJECT_PATH (e.g., "frontend") → creates "platform/repo/frontend"
#
# Variables:
#   ENABLE_DTRACK: "true"               # Enable DTrack upload (default: false)
#   DTRACK_URL: ""                      # DTrack base URL (default: https://api.dtrack.cnc-demo.liip.cloud)
#   DTRACK_API_KEY: ""                  # Required: DTrack API key (set as CI/CD secret, do not define in variables)
#   DTRACK_PROJECT_UUID: ""             # Optional: Explicit project UUID (takes precedence)
#   DTRACK_PROJECT_NAME: ""             # Optional: Override auto-generated project name
#   DTRACK_PROJECT_VERSION: ""          # Optional: Override version (default: CI_COMMIT_TAG or CI_COMMIT_SHORT_SHA)
#   PROJECT_PATH: ""                    # Optional: Monorepo subproject path (e.g., "frontend")

dtrack-upload:
  stage: source
  image: aquasec/trivy:0.58.1
  variables:
    # Default Dependency-Track instance URL (can be overridden per project)
    DTRACK_URL: "https://api.dtrack.cnc-demo.liip.cloud"
  before_script:
    - |
      # Install dependencies for base64 encoding and API calls
      apk add --no-cache curl jq coreutils
  script:
    - trivy --version
    - |
      set -e

      if [ -z "$DTRACK_API_KEY" ]; then
        echo "ERROR: DTRACK_API_KEY is required but not set"
        exit 1
      fi

      # Determine project path (monorepo support)
      SCAN_PATH="${PROJECT_PATH:-.}"

      echo "================================================"
      echo "Generating CycloneDX SBOM for Dependency-Track"
      echo "Scan path: ${SCAN_PATH}"
      echo "================================================"

      # Generate CycloneDX SBOM
      trivy fs \
        --format cyclonedx \
        --output bom.json \
        "${SCAN_PATH}"

      # Check if SBOM was generated
      if [ ! -f "bom.json" ]; then
        echo "ERROR: Failed to generate SBOM"
        exit 1
      fi

      SBOM_SIZE=$(stat -c%s bom.json)
      echo "SBOM generated successfully (${SBOM_SIZE} bytes)"

      echo "================================================"
      echo "Uploading SBOM to Dependency-Track"
      echo "DTrack URL: ${DTRACK_URL}"
      echo "================================================"

      RESPONSE_FILE="dtrack-response.json"

      if [ -n "$DTRACK_PROJECT_UUID" ]; then
        # Option 1: Use explicit project UUID (PUT with JSON)
        echo "Using explicit project UUID: ${DTRACK_PROJECT_UUID}"

        # Base64 encode the SBOM
        BOM_B64=$(base64 -w 0 < bom.json)

        # Construct JSON payload and upload via stdin
        HTTP_CODE=$(printf '%s' "$BOM_B64" | jq -R -s \
          --arg project "$DTRACK_PROJECT_UUID" \
          '{project: $project, bom: .}' | \
          curl -w "%{http_code}" -o "$RESPONSE_FILE" \
          --retry 1 \
          --retry-delay 5 \
          --max-time 60 \
          -X PUT "${DTRACK_URL}/api/v1/bom" \
          -H "Content-Type: application/json" \
          -H "X-Api-Key: ${DTRACK_API_KEY}" \
          --data-binary @-)
      else
        # Option 2: Auto-create with project name and version (POST with multipart/form-data)
        # Construct project name (monorepo support)
        if [ -n "$DTRACK_PROJECT_NAME" ]; then
          PROJECT_NAME="$DTRACK_PROJECT_NAME"
        else
          PROJECT_NAME="${CI_PROJECT_NAME}"
          if [ -n "$PROJECT_PATH" ]; then
            PROJECT_NAME="${CI_PROJECT_NAME}/${PROJECT_PATH}"
          fi
        fi

        # Determine version
        PROJECT_VERSION="${DTRACK_PROJECT_VERSION:-${CI_COMMIT_TAG:-${CI_COMMIT_REF_SLUG}}}"

        # Check if project already exists to give meaningful feedback
        LOOKUP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          "${DTRACK_URL}/api/v1/project/lookup?name=${PROJECT_NAME}&version=${PROJECT_VERSION}" \
          -H "X-Api-Key: ${DTRACK_API_KEY}")

        if [ "$LOOKUP_CODE" -eq 200 ]; then
          echo "Project '${PROJECT_NAME}' (${PROJECT_VERSION}) already exists — updating BOM"
        elif [ "$LOOKUP_CODE" -eq 404 ]; then
          echo "Project '${PROJECT_NAME}' (${PROJECT_VERSION}) not found — will be auto-created"
        else
          echo "Warning: Unexpected response from project lookup (HTTP ${LOOKUP_CODE}) — proceeding with upload"
        fi

        # Upload using POST with multipart/form-data (supports autoCreate)
        HTTP_CODE=$(curl -w "%{http_code}" -o "$RESPONSE_FILE" \
          --retry 1 \
          --retry-delay 5 \
          --max-time 60 \
          -X POST "${DTRACK_URL}/api/v1/bom" \
          -H "X-Api-Key: ${DTRACK_API_KEY}" \
          -F "autoCreate=true" \
          -F "projectName=${PROJECT_NAME}" \
          -F "projectVersion=${PROJECT_VERSION}" \
          -F "bom=@bom.json")
      fi

      echo "HTTP Status Code: ${HTTP_CODE}"

      # Check response
      if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
        echo "✓ SBOM uploaded successfully"
        if [ -f "$RESPONSE_FILE" ] && [ -s "$RESPONSE_FILE" ]; then
          echo "Response:"
          cat "$RESPONSE_FILE" | jq . || cat "$RESPONSE_FILE"
        fi
      else
        echo "✗ Failed to upload SBOM"
        echo "Response:"
        cat "$RESPONSE_FILE" | jq . || cat "$RESPONSE_FILE"
        exit 1
      fi
  rules:
    - if: '$ENABLE_DTRACK == "true"'
    - when: never
  allow_failure: false
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - bom.json
      - dtrack-response.json
