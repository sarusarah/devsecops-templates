---
# OWASP SPVS: Develop Phase - Source code security
# Dependency Scanning - Software Composition Analysis (SCA)
#
# Scans project dependencies for known vulnerabilities (CVEs) in third-party libraries
# and packages. Integrates with GitLab Security Dashboard for centralized vulnerability
# management and tracking.
#
# Quick Start:
#   variables:
#     ENABLE_DEPENDENCY_SCAN: "true"
#     LANGUAGE: "node"  # or "python", "php"
#     SECURITY_SCANNER: "trivy"  # or "specialized"
#
# Scanner Options:
#   Trivy (Default):
#     - Unified vulnerability scanner
#     - Fast and comprehensive
#     - Supports all languages automatically
#     - Recommended for most projects
#
#   Specialized Tools:
#     - npm audit (Node.js)
#     - pip-audit (Python)
#     - composer audit (PHP)
#     - Purpose-built for each language
#     - More detailed language-specific insights
#
# Variables:
#   ENABLE_DEPENDENCY_SCAN: "true"      # Enable dependency scanning (default: "true")
#   SECURITY_SCANNER: "trivy"           # Scanner: "trivy" or "specialized" (default: "trivy")
#   LANGUAGE: "node"                    # Language: "node", "python", "php" (required for specialized)
#   PROJECT_PATH: ""                    # Monorepo: subproject path (e.g., "backend")
#   SECURITY_POLICY: "strict"           # Policy: "strict" or "permissive" (default: "strict")
#
# Supported Package Managers:
#   Node.js: npm, yarn, pnpm (package.json, package-lock.json, yarn.lock, pnpm-lock.yaml)
#   Python: pip, poetry (requirements.txt, Pipfile, pyproject.toml)
#   PHP: composer (composer.json, composer.lock)
#
# Monorepo Support:
#   Scan specific subdirectory:
#   variables:
#     PROJECT_PATH: "backend"
#     LANGUAGE: "python"
#     ENABLE_DEPENDENCY_SCAN: "true"
#
# See Also:
#   - https://aquasecurity.github.io/trivy/
#   - https://docs.gitlab.com/ee/user/application_security/dependency_scanning/

# Trivy-based dependency scanning (recommended for unified tooling)
dependency-scanning:
  stage: source
  image: aquasec/trivy:0.58.1
  script:
    - trivy --version
    - |
      trivy fs \
        --scanners vuln \
        --severity HIGH,CRITICAL \
        --format json \
        --output dependency-scan.json \
        "${PROJECT_PATH:-.}"
  rules:
    - if: '$ENABLE_DEPENDENCY_SCAN == "true" && $SECURITY_SCANNER == "trivy"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - dependency-scan.json
    reports:
      dependency_scanning: dependency-scan.json

# Language-specific dependency scanning (specialized tools)
dependency-scanning-specialized:
  stage: source
  image: alpine:3.20
  script:
    - apk add --no-cache bash curl jq python3 py3-pip nodejs npm php-cli php-phar php-openssl
    - |
      set -e
      cd "${PROJECT_PATH:-.}"
      case "${LANGUAGE}" in
        php)
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          composer audit --format=json > dependency-scan.json || true
          ;;
        python)
          pip install -U pip pip-audit
          if [ -f "requirements.txt" ]; then pip-audit -r requirements.txt -f json > dependency-scan.json || true; else echo "[]" > dependency-scan.json; fi
          ;;
        node)
          if [ -f "package-lock.json" ] || [ -f "package.json" ]; then npm audit --json > dependency-scan.json || true; else echo "{}" > dependency-scan.json; fi
          ;;
        *)
          echo "{}" > dependency-scan.json
          ;;
      esac
  rules:
    - if: '$ENABLE_DEPENDENCY_SCAN == "true" && $SECURITY_SCANNER == "specialized"'
    - when: never
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - dependency-scan.json
    reports:
      dependency_scanning: dependency-scan.json
