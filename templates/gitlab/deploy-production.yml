---
# OWASP SPVS: Release Phase - Production deployment
# Production Deployment - GitOps-based deployment to production environment
#
# Deploys applications to production environment using GitOps methodology. Requires
# manual approval on default branch for safety. Supports separate production branches
# and configuration files in GitOps repository.
#
# Quick Start:
#   variables:
#     GITOPS_REPO: "git@gitlab.example.com:gitops/myapp.git"
#     GITOPS_SSH_KEY: "${GITOPS_SSH_KEY}"  # Set as CI/CD secret
#     PRODUCTION_URL: "https://example.com"
#     GITOPS_PRODUCTION_PATH: "production/values.yaml"
#
# How It Works:
#   1. Clone GitOps repository
#   2. Optionally checkout production branch
#   3. Update image tag in production values file
#   4. Commit and push changes
#   5. GitOps operator deploys to production
#
# Variables:
#   GITOPS_REPO: ""                     # Required: GitOps repository URL
#   GITOPS_SSH_KEY: ""                  # Required: SSH private key for GitOps repo
#   GITOPS_PRODUCTION_PATH: ""          # Production values file (default: GITOPS_PATH or "values.yaml")
#   GITOPS_PRODUCTION_BRANCH: ""        # Optional: Production branch name
#   GITOPS_IMAGE_TAG_YQ_PATH: ".image.tag"  # YQ path to image tag field
#   GITOPS_PRODUCTION_COMMIT_MESSAGE: ""    # Commit message template
#   IMAGE_TAG: ""                       # Image tag to deploy (default: CI_COMMIT_SHA)
#   PRODUCTION_URL: ""                  # Production environment URL
#
# Safety Features:
#   Manual Approval Required:
#     - On default branch: Always requires manual trigger
#     - On tags: Automatic deployment
#     - Prevents accidental production deployments
#
#   Separate Configuration:
#     - Use GITOPS_PRODUCTION_PATH for prod-specific config
#     - Use GITOPS_PRODUCTION_BRANCH for branch-based isolation
#
# GitOps Repository Patterns:
#   Pattern 1 - Environment directories:
#     staging/values.yaml
#     production/values.yaml
#
#   Pattern 2 - Separate branches:
#     main → staging environment
#     production → production environment
#
#   Pattern 3 - Single file with overlays:
#     base/values.yaml
#     overlays/production/values.yaml
#
# Pipeline Behavior:
#   Default branch: Manual deployment (requires approval)
#   Tags: Automatic deployment (e.g., v1.0.0)
#   Other branches: No deployment
#
# Tag-based Deployment:
#   Recommended for production:
#   1. Create git tag: git tag v1.0.0
#   2. Push tag: git push origin v1.0.0
#   3. Pipeline automatically deploys to production
#
# Environment Integration:
#   Creates GitLab environment:
#     - Name: production
#     - URL: PRODUCTION_URL
#     - Deployment tier: production
#   Visible in GitLab Environments page
#   Supports deployment history and rollbacks
#
# Customization Examples:
#   Deploy from staging image:
#   deploy-production:
#     extends: .deploy:production:base
#     variables:
#       IMAGE_TAG: "${STAGING_IMAGE_TAG}"
#
#   Production-specific config:
#   deploy-production:
#     extends: .deploy:production:base
#     variables:
#       GITOPS_PRODUCTION_PATH: "production/values.yaml"
#       GITOPS_PRODUCTION_BRANCH: "production"
#
# Approval Workflow:
#   1. Staging deployment completes
#   2. Team verifies in staging
#   3. Manually triggers production deployment
#   4. GitOps deploys to production
#   5. Post-deployment monitoring verifies
#
# Rollback:
#   Manual rollback via GitOps:
#   1. Revert commit in GitOps repo
#   2. GitOps operator rolls back
#
#   Or redeploy previous version:
#   1. Find previous commit SHA
#   2. Manually run pipeline with IMAGE_TAG set
#
# Troubleshooting:
#   "GITOPS_REPO is required":
#     - Set GITOPS_REPO variable
#
#   Deployment not triggered:
#     - Check if on default branch or tag
#     - Verify manual approval clicked
#
#   Wrong environment deployed:
#     - Verify GITOPS_PRODUCTION_PATH points to correct file
#     - Check GITOPS_PRODUCTION_BRANCH if using branches
#
# See Also:
#   - https://argoproj.github.io/cd/
#   - https://fluxcd.io/
#   - https://docs.gitlab.com/ee/ci/environments/

.deploy:production:base:
  stage: deploy
  image: alpine/git:latest
  before_script:
    - apk add --no-cache yq bash curl
    - |
      # Verify required variables
      if [ -z "${GITOPS_REPO}" ]; then
        echo "GITOPS_REPO is required (e.g., git@gitlab.example.com:gitops/app.git)"
        exit 1
      fi
      if [ -z "${PRODUCTION_URL}" ]; then
        echo "Warning: PRODUCTION_URL not set"
      fi
      # Setup SSH key for GitOps repo
      if [ -n "${GITOPS_SSH_KEY}" ]; then
        mkdir -p ~/.ssh
        echo "${GITOPS_SSH_KEY}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H gitlab.com >> ~/.ssh/known_hosts 2>/dev/null || true
      fi
  script:
    - |
      echo "Deploying to production via GitOps..."

      # Clone GitOps repository
      git clone "${GITOPS_REPO}" gitops-repo
      cd gitops-repo

      # Checkout production branch if specified
      if [ -n "${GITOPS_PRODUCTION_BRANCH}" ]; then
        git checkout "${GITOPS_PRODUCTION_BRANCH}"
      fi

      # Configure git
      git config user.email "ci@${CI_PROJECT_PATH_SLUG}.gitlab.com"
      git config user.name "GitLab CI"

      # Update image tag in values file
      IMAGE_TAG_VALUE="${IMAGE_TAG:-$CI_COMMIT_SHA}"
      GITOPS_FILE="${GITOPS_PRODUCTION_PATH:-${GITOPS_PATH:-values.yaml}}"
      YQ_PATH="${GITOPS_IMAGE_TAG_YQ_PATH:-.image.tag}"

      echo "Updating ${GITOPS_FILE} at path ${YQ_PATH} to ${IMAGE_TAG_VALUE}"

      # Update the file using yq
      yq eval "${YQ_PATH} = \"${IMAGE_TAG_VALUE}\"" -i "${GITOPS_FILE}"

      # Commit and push changes
      git add "${GITOPS_FILE}"
      git diff --cached --quiet && echo "No changes to commit" && exit 0

      COMMIT_MSG="${GITOPS_PRODUCTION_COMMIT_MESSAGE:-Deploy ${CI_COMMIT_SHORT_SHA} to production}"
      git commit -m "${COMMIT_MSG}"
      git push origin HEAD

      echo "Successfully deployed ${IMAGE_TAG_VALUE} to production"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - when: never
  environment:
    name: production
    url: ${PRODUCTION_URL}
    deployment_tier: production

deploy-production:
  extends: .deploy:production:base
  variables:
    IMAGE_TAG: ${CI_COMMIT_SHA}
