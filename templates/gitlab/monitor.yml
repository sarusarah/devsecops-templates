---
# OWASP SPVS: Operate Phase - Continuous monitoring and health checks
# Monitoring Template - Post-deployment health verification
#
# Performs automated health checks after deployment to verify application availability
# and functionality. Runs in the operate stage after successful deployment to production
# or staging environments.
#
# Quick Start:
#   variables:
#     HEALTHCHECK_URL: "https://api.example.com/health"
#     MONITOR_WAIT_SECONDS: "30"
#
# How It Works:
#   1. Waits for deployment to stabilize (configurable delay)
#   2. Sends HTTP request to health check endpoint
#   3. Verifies HTTP 200 response
#   4. Fails pipeline if health check fails
#
# Variables:
#   HEALTHCHECK_URL: ""                 # Required: Health check endpoint URL
#   MONITOR_WAIT_SECONDS: "20"          # Wait time before checking (default: "20")
#
# Health Check Requirements:
#   Endpoint must:
#     - Return HTTP 200 status code
#     - Respond within reasonable timeout
#     - Be accessible from CI runner network
#
# Typical Health Check Endpoints:
#   - /health
#   - /healthz
#   - /api/health
#   - /status
#
# Example Health Check Response:
#   HTTP 200 OK
#   {"status": "healthy", "version": "1.0.0"}
#
# Pipeline Integration:
#   Runs after deployment:
#     deploy-production â†’ post-deployment-monitoring
#
#   Only runs on default branch (main/master)
#   Requires successful deployment
#
# Failure Handling:
#   If health check fails:
#     - Pipeline marked as failed
#     - Alerts team to investigate
#     - May trigger rollback (if configured)
#
# Custom Health Checks:
#   Override for complex checks:
#   post-deployment-monitoring:
#     script:
#       - curl -f ${HEALTHCHECK_URL}
#       - ./scripts/custom-validation.sh
#
# See Also:
#   - https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/

post-deployment-monitoring:
  stage: operate
  image: alpine:3.20
  script:
    - apk add --no-cache curl bash
    - |
      if [ -z "${HEALTHCHECK_URL}" ]; then
        echo "HEALTHCHECK_URL not set. Skipping monitoring."
        exit 0
      fi
      echo "Waiting for deployment to stabilize..."
      sleep "${MONITOR_WAIT_SECONDS:-20}"
      echo "Checking health at ${HEALTHCHECK_URL}..."
      curl -fsS "${HEALTHCHECK_URL}"
      echo "Health check OK."
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
