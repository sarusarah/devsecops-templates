---
# OWASP SPVS: Develop Phase - Testing and validation
# Test Templates - Language-specific test job templates
#
# Provides reusable test job templates for Node.js, Python, and PHP applications.
# Includes code coverage reporting and GitLab test report integration. Extends the
# base test configuration with language-specific test runners.
#
# Quick Start:
#   Node.js:
#     test-app:
#       extends: .test:node
#       variables:
#         NODE_VERSION: "20"
#         PACKAGE_MANAGER: "pnpm"
#
#   Python:
#     test-app:
#       extends: .test:python
#       variables:
#         PYTHON_VERSION: "3.12"
#
#   PHP:
#     test-app:
#       extends: .test:phpunit
#       variables:
#         PHP_VERSION: "8.3"
#
# Variables - Node.js:
#   NODE_VERSION: "20"                  # Node.js version (default: "20")
#   PACKAGE_MANAGER: "npm"              # Package manager: "npm", "yarn", "pnpm" (default: "npm")
#   PROJECT_PATH: ""                    # Monorepo: subproject path (e.g., "frontend")
#
# Variables - Python:
#   PYTHON_VERSION: "3.12"              # Python version (default: "3.12")
#   PROJECT_PATH: ""                    # Monorepo: subproject path (e.g., "backend")
#
# Variables - PHP:
#   PHP_VERSION: "8.3"                  # PHP version (default: "8.3")
#   PROJECT_PATH: ""                    # Monorepo: subproject path (e.g., "api")
#
# Variables - Pipeline Control:
#   RUN_ON_BRANCHES: "false"            # Run on all branches or MR/main only (default: "false")
#
# Test Frameworks:
#   Node.js: Automatically detects and runs configured test runner (Jest, Vitest, etc.)
#   Python: Uses pytest with coverage reporting
#   PHP: Uses PHPUnit with coverage reporting
#
# Coverage Reporting:
#   Python: Generates cobertura coverage report (coverage.xml)
#   PHP: Generates cobertura coverage report (coverage.xml)
#   Node.js: Depends on test framework configuration
#
#   GitLab displays coverage in merge requests and coverage trends.
#
# Test Reports:
#   Python: JUnit XML format for test results
#   All languages: Artifacts expire after 7 days
#
# Monorepo Support:
#   Test specific component:
#   test-frontend:
#     extends: .test:node
#     variables:
#       PROJECT_PATH: "frontend"
#       PACKAGE_MANAGER: "pnpm"
#
# Custom Test Commands:
#   Override script for custom test execution:
#   test-app:
#     extends: .test:node
#     script:
#       - npm ci
#       - npm run test:integration
#       - npm run test:e2e
#
# See Also:
#   - https://docs.gitlab.com/ee/ci/testing/
#   - https://docs.gitlab.com/ee/ci/testing/code_coverage.html

.test:base:
  stage: test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$RUN_ON_BRANCHES == "true"'
  artifacts:
    when: always
    expire_in: 7 days

.test:node:
  extends: .test:base
  image: node:${NODE_VERSION:-20}-alpine
  before_script:
    - cd "${PROJECT_PATH:-.}"
  script:
    - corepack enable
    - |
      if [ "${PACKAGE_MANAGER:-npm}" = "pnpm" ]; then
        pnpm install --frozen-lockfile
        pnpm test -- --ci
      elif [ "${PACKAGE_MANAGER:-npm}" = "yarn" ]; then
        yarn install --frozen-lockfile
        yarn test
      else
        npm ci
        npm test
      fi

.test:python:
  extends: .test:base
  image: python:${PYTHON_VERSION:-3.12}-slim
  before_script:
    - cd "${PROJECT_PATH:-.}"
  script:
    - python -m pip install -U pip
    - pip install pytest pytest-cov
    - |
      if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
      pytest -q --junitxml=junit.xml --cov=. --cov-report=xml:coverage.xml
  artifacts:
    reports:
      junit: ${PROJECT_PATH:-.}/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${PROJECT_PATH:-.}/coverage.xml
    paths:
      - ${PROJECT_PATH:-.}/junit.xml
      - ${PROJECT_PATH:-.}/coverage.xml

.test:phpunit:
  extends: .test:base
  image: php:${PHP_VERSION:-8.3}-cli
  before_script:
    - cd "${PROJECT_PATH:-.}"
    - php -v
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - |
      # Install dependencies if vendor doesn't exist from build stage
      if [ ! -d "vendor" ]; then
        composer install --no-interaction --prefer-dist --optimize-autoloader
      fi
  script:
    - |
      if [ -f "vendor/bin/phpunit" ]; then
        vendor/bin/phpunit --coverage-clover coverage.xml
      elif [ -f "bin/phpunit" ]; then
        php bin/phpunit --coverage-clover coverage.xml
      else
        echo "PHPUnit not found in vendor/bin/phpunit or bin/phpunit"
        exit 1
      fi
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ${PROJECT_PATH:-.}/coverage.xml
    paths:
      - ${PROJECT_PATH:-.}/coverage.xml
