---
name: Security - Dependency-Track SBOM Upload

on:
  workflow_call:
    inputs:
      project_path:
        description: 'Project directory path (for monorepo support)'
        required: false
        type: string
        default: '.'
      dtrack_url:
        description: 'Dependency-Track base URL (e.g., https://api.dtrack.example.com)'
        required: true
        type: string
      dtrack_project_uuid:
        description: 'DTrack project UUID (optional - takes precedence over auto-create)'
        required: false
        type: string
        default: ''
      dtrack_project_name:
        description: 'DTrack project name (optional - overrides auto-generated name)'
        required: false
        type: string
        default: ''
      dtrack_project_version:
        description: 'DTrack project version (optional - defaults to branch/tag name)'
        required: false
        type: string
        default: ''
    secrets:
      dtrack_api_key:
        description: 'Dependency-Track API key'
        required: true

jobs:
  dtrack-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Generate CycloneDX SBOM
        working-directory: ${{ inputs.project_path }}
        run: |
          echo "================================================"
          echo "Generating CycloneDX SBOM for Dependency-Track"
          echo "Scan path: ${{ inputs.project_path }}"
          echo "================================================"

          trivy --version

          trivy fs \
            --format cyclonedx \
            --output bom.json \
            .

          if [ ! -f "bom.json" ]; then
            echo "ERROR: Failed to generate SBOM"
            exit 1
          fi

          SBOM_SIZE=$(stat -c%s bom.json)
          echo "SBOM generated successfully (${SBOM_SIZE} bytes)"

      - name: Upload SBOM to Dependency-Track
        working-directory: ${{ inputs.project_path }}
        env:
          DTRACK_URL: ${{ inputs.dtrack_url }}
          DTRACK_API_KEY: ${{ secrets.dtrack_api_key }}
          DTRACK_PROJECT_UUID: ${{ inputs.dtrack_project_uuid }}
          DTRACK_PROJECT_NAME: ${{ inputs.dtrack_project_name }}
          DTRACK_PROJECT_VERSION: ${{ inputs.dtrack_project_version }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          PROJECT_PATH: ${{ inputs.project_path }}
        run: |
          set -e

          echo "================================================"
          echo "Uploading SBOM to Dependency-Track"
          echo "DTrack URL: ${DTRACK_URL}"
          echo "================================================"

          RESPONSE_FILE="dtrack-response.json"

          if [ -n "$DTRACK_PROJECT_UUID" ]; then
            # Option 1: Use explicit project UUID (PUT with JSON)
            echo "Using explicit project UUID: ${DTRACK_PROJECT_UUID}"

            # Base64 encode the SBOM
            BOM_B64=$(base64 -w 0 < bom.json)

            # Use stdin to avoid "Argument list too long" for large SBOMs
            HTTP_CODE=$(printf '%s' "$BOM_B64" | jq -R -s \
              --arg project "$DTRACK_PROJECT_UUID" \
              '{project: $project, bom: .}' | \
              curl -w "%{http_code}" -o "$RESPONSE_FILE" \
              --retry 1 \
              --retry-delay 5 \
              --max-time 60 \
              -X PUT "${DTRACK_URL}/api/v1/bom" \
              -H "Content-Type: application/json" \
              -H "X-Api-Key: ${DTRACK_API_KEY}" \
              --data-binary @-)
          else
            # Option 2: Auto-create with project name and version (POST with multipart/form-data)
            # Construct project name (monorepo support)
            if [ -n "$DTRACK_PROJECT_NAME" ]; then
              PROJECT_NAME="$DTRACK_PROJECT_NAME"
            else
              PROJECT_NAME="$GITHUB_REPOSITORY"
              if [ "$PROJECT_PATH" != "." ] && [ -n "$PROJECT_PATH" ]; then
                PROJECT_NAME="${GITHUB_REPOSITORY}/${PROJECT_PATH}"
              fi
            fi

            VERSION="${DTRACK_PROJECT_VERSION:-${GITHUB_REF_NAME}}"

            # Check if project already exists to give meaningful feedback
            LOOKUP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "${DTRACK_URL}/api/v1/project/lookup?name=${PROJECT_NAME}&version=${VERSION}" \
              -H "X-Api-Key: ${DTRACK_API_KEY}")

            if [ "$LOOKUP_CODE" -eq 200 ]; then
              echo "Project '${PROJECT_NAME}' (${VERSION}) already exists — updating BOM"
            elif [ "$LOOKUP_CODE" -eq 404 ]; then
              echo "Project '${PROJECT_NAME}' (${VERSION}) not found — will be auto-created"
            else
              echo "Warning: Unexpected response from project lookup (HTTP ${LOOKUP_CODE}) — proceeding with upload"
            fi

            HTTP_CODE=$(curl -w "%{http_code}" -o "$RESPONSE_FILE" \
              --retry 1 \
              --retry-delay 5 \
              --max-time 60 \
              -X POST "${DTRACK_URL}/api/v1/bom" \
              -H "X-Api-Key: ${DTRACK_API_KEY}" \
              -F "autoCreate=true" \
              -F "projectName=${PROJECT_NAME}" \
              -F "projectVersion=${VERSION}" \
              -F "bom=@bom.json")
          fi

          echo "HTTP Status Code: ${HTTP_CODE}"

          # Check response
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "✓ SBOM uploaded successfully"
            if [ -f "$RESPONSE_FILE" ] && [ -s "$RESPONSE_FILE" ]; then
              echo "Response:"
              cat "$RESPONSE_FILE" | jq . || cat "$RESPONSE_FILE"
            fi
          else
            echo "✗ Failed to upload SBOM"
            echo "Response:"
            cat "$RESPONSE_FILE" | jq . || cat "$RESPONSE_FILE"
            exit 1
          fi

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dtrack-sbom-${{ inputs.project_path != '.' && inputs.project_path || 'root' }}
          path: |
            ${{ inputs.project_path }}/bom.json
            ${{ inputs.project_path }}/dtrack-response.json
          retention-days: 7
