---
include:
  - project: platform/devsecops-template
    ref: v1.0.0
    file:
      - /templates/gitlab/base.yml
      - /templates/gitlab/security/secrets.yml
      - /templates/gitlab/security/dependency.yml
      - /templates/gitlab/security/sast.yml
      - /templates/gitlab/security/dtrack.yml
      - /templates/gitlab/deploy-staging.yml
      - /templates/gitlab/deploy-production.yml
      - /templates/gitlab/monitor.yml
      - /templates/gitlab/ai-report.yml           # Optional: AI pipeline analysis + Slack

variables:
  APP_NAME: "nuxt-app"
  LANGUAGE: "node"
  NODE_VERSION: "20"
  PACKAGE_MANAGER: "pnpm"          # npm|yarn|pnpm

  # Use specialized tools for comprehensive JavaScript/TypeScript analysis
  SECURITY_SCANNER: "specialized"
  SAST_TOOL: "semgrep"             # Semgrep has excellent JS/TS rules

  ENABLE_DAST: "true"
  STAGING_URL: "https://staging.example.com"
  GITOPS_REPO: "git@gitlab.example.com:gitops/nuxt-app.git"

  # Dependency-Track SBOM upload (optional)
  ENABLE_DTRACK: "false"  # Set to "true" and configure DTRACK_URL + DTRACK_API_KEY to enable
  # DTRACK_URL: "https://api.dtrack.example.com"
  # DTRACK_API_KEY: "${DTRACK_API_KEY}"  # Set as CI/CD secret variable

  # AI-powered pipeline analysis + Slack notifications (optional)
  ENABLE_AI_REPORT: "false"  # Set to "true" and configure AI_API_KEY + SLACK_WEBHOOK_URL
  # AI_PROVIDER: "gemini"   # or "openai" (default: "gemini")
  # AI_API_KEY: set as CI/CD secret (Gemini or OpenAI API key)
  # SLACK_WEBHOOK_URL: set as CI/CD secret (Slack incoming webhook)

# Team-spezifische Implementierung via extends, ohne Template zu kopieren
build-application:
  stage: build
  image: node:${NODE_VERSION}-alpine
  script:
    - corepack enable
    - pnpm install --frozen-lockfile
    - pnpm build
  artifacts:
    paths:
      - .output/
      - .nuxt/
      - node_modules/

unit-tests:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - corepack enable
    - pnpm install --frozen-lockfile
    - pnpm test -- --ci
  artifacts:
    when: always
    reports:
      junit: junit.xml
    paths:
      - junit.xml

# Optional: E2E gegen Staging (Phase 7-8)
e2e-tests:
  stage: test
  image: cypress/included:15.3.0
  script:
    - cypress run --config baseUrl=${STAGING_URL}
  rules:
    - if: $ENABLE_E2E == "true"
